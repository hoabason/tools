<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Công cụ cho Obsidian - Xuân Hòa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .form-input, .form-select {
            background-color: #374151; /* bg-gray-700 */
            border-color: #4b5563; /* border-gray-600 */
            color: #f3f4f6; /* text-gray-200 */
        }
        .form-input::placeholder {
            color: #9ca3af; /* placeholder-gray-400 */
        }
        .main-tab {
            transition: color 0.2s, border-color 0.2s;
        }
        .main-tab.active {
            color: #22d3ee; /* text-cyan-400 */
            border-color: #22d3ee; /* border-cyan-400 */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        /* Custom scrollbar for the output code */
        #outputCode::-webkit-scrollbar, #desktopLinkOutput::-webkit-scrollbar, #singleLinkOutput::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        #outputCode::-webkit-scrollbar-track, #desktopLinkOutput::-webkit-scrollbar-track, #singleLinkOutput::-webkit-scrollbar-track {
            background: #1f2937; /* bg-gray-800 */
            border-radius: 10px;
        }
        #outputCode::-webkit-scrollbar-thumb, #desktopLinkOutput::-webkit-scrollbar-thumb, #singleLinkOutput::-webkit-scrollbar-thumb {
            background: #4b5563; /* bg-gray-600 */
            border-radius: 10px;
        }
        #outputCode::-webkit-scrollbar-thumb:hover, #desktopLinkOutput::-webkit-scrollbar-thumb:hover, #singleLinkOutput::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* bg-gray-500 */
        }
    </style>
</head>
<body class="text-white p-4 sm:p-6 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-cyan-400">CÔNG CỤ XỬ LÝ ĐẦU VÀO OBSIDIAN</h1>
        </div>
        
        <!-- Tab Navigation -->
        <div class="mb-8 border-b border-gray-700">
            <nav class="flex -mb-px space-x-6" aria-label="Tabs">
                <button class="main-tab active py-4 px-1 border-b-2 font-medium text-lg" data-tab="desktopLink">
                    Liên kết Desktop & Obsidian 
                </button>
                <button class="main-tab text-gray-400 hover:text-gray-200 border-transparent py-4 px-1 border-b-2 font-medium text-lg" data-tab="chronos">
                    Chronos Timeline
                </button>
            </nav>
        </div>

        <!-- Tab Content -->
        <div id="chronosTabContent" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Left Column: Input Form -->
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                    <!-- Task Entry Form -->
                    <div class="mb-6">
                         <h2 class="text-2xl font-semibold mb-4 border-b-2 border-cyan-500 pb-2 flex justify-between items-center">
                            <span>1. Thêm hoặc Cập nhật công việc</span>
                            <button type="button" id="resetFormButton" class="text-gray-400 hover:text-white transition-colors duration-200 p-1 rounded-full hover:bg-gray-700" title="Xóa hết thông tin đã nhập">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"/><path d="M1 20v-6h6"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L20.5 10"/><path d="M20.49 15a9 9 0 0 1-14.85 3.36L3.5 14"/></svg>
                            </button>
                        </h2>
                        <form id="taskForm" class="space-y-4">
                            <input type="hidden" id="editingTaskId">
                            <div>
                                <label for="taskType" class="block mb-2 text-sm font-medium text-gray-300">Loại Task</label>
                                <select id="taskType" class="form-select block w-full rounded-lg border p-2.5">
                                    <option value="period" selected>@ Task lớn</option>
                                    <option value="event">- Task nhỏ</option>
                                    <option value="marker">= Task quan trọng</option>
                                </select>
                            </div>
                            
                            <div id="groupContainer">
                                <label for="taskGroup" class="block mb-2 text-sm font-medium text-gray-300">Tên Task lớn</label>
                                <input type="text" id="taskGroup" list="group-suggestions" class="form-input block w-full rounded-lg border p-2.5" placeholder="VD: V-top, Cá nhân">
                            </div>
                            <datalist id="group-suggestions"></datalist>

                            <div id="taskNameContainer">
                                <label for="taskName" class="block mb-2 text-sm font-medium text-gray-300">Tên Task</label>
                                <input type="text" id="taskName" class="form-input block w-full rounded-lg border p-2.5" placeholder="Tên của công việc" required>
                            </div>
                            
                            <div id="noteContainer">
                                <label for="taskNote" class="block mb-2 text-sm font-medium text-gray-300">Thông tin ghi chú</label>
                                <textarea id="taskNote" class="form-input block w-full rounded-lg border p-2.5" placeholder="Ghi chú thêm, hiện khi hover" rows="4"></textarea>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label for="startDate" class="block mb-2 text-sm font-medium text-gray-300">Ngày bắt đầu</label>
                                    <input type="date" id="startDate" class="form-input block w-full rounded-lg border p-2.5" required>
                                </div>
                                <div id="endDateContainer">
                                    <label for="endDate" class="block mb-2 text-sm font-medium text-gray-300">Ngày kết thúc</label>
                                    <input type="date" id="endDate" class="form-input block w-full rounded-lg border p-2.5">
                                </div>
                            </div>
                            <p id="date-error" class="text-red-400 text-sm mt-1 hidden">Lỗi: Chọn ngày kết thúc lớn hơn hoặc bằng ngày bắt đầu.</p>

                            <div id="detailsContainer" class="grid grid-cols-1 sm:grid-cols-1 gap-4">
                                 <div>
                                    <label for="taskColor" class="block mb-2 text-sm font-medium text-gray-300">Màu sắc</label>
                                    <select id="taskColor" class="form-select block w-full rounded-lg border p-2.5">
                                        <option value="">Không màu</option>
                                        <option value="#red">Đỏ</option>
                                        <option value="#orange">Cam</option>
                                        <option value="#yellow">Vàng</option>
                                        <option value="#green">Xanh lá</option>
                                        <option value="#blue">Xanh dương</option>
                                        <option value="#purple">Tím</option>
                                        <option value="#pink">Hồng</option>
                                        <option value="#cyan">Xanh ngọc</option>
                                    </select>
                                </div>
                            </div>

                            <button type="submit" id="submitButton" class="w-full text-white bg-cyan-600 hover:bg-cyan-700 focus:ring-4 focus:outline-none focus:ring-cyan-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors duration-200">Thêm vào danh sách</button>
                        </form>
                    </div>
                     <h2 class="text-2xl font-semibold mb-4 border-b-2 border-cyan-500 pb-2">2. Danh sách công việc đã thêm</h2>
                     <div id="tab-container" class="flex border-b border-gray-600 mb-2 flex-wrap"></div>
                     <div id="taskList" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                        <!-- Added tasks will appear here -->
                         <p class="text-gray-400 text-center italic">Chưa có công việc nào được thêm...</p>
                     </div>
                </div>

                <!-- Right Column: Code Output -->
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700 sticky top-8 self-start">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">Code Chronos Timeline</h2>
                        <div>
                             <button id="copyButton" class="bg-gray-700 hover:bg-gray-600 text-gray-300 font-medium py-1 px-3 rounded-lg text-sm transition-colors duration-200">Sao chép</button>
                             <div id="copySuccessMessage" class="bg-green-600 text-white font-medium py-1 px-3 rounded-lg text-sm hidden">Đã sao chép!</div>
                        </div>
                    </div>
                    <pre class="bg-gray-900 rounded-lg p-4 h-[600px] overflow-auto"><code id="outputCode" class="text-sm"></code></pre>
                </div>
            </div>
        </div>

        <div id="desktopLinkTabContent" class="tab-content active">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                 <!-- Left Column: Input -->
                <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                    <h2 class="text-2xl font-semibold mb-4 border-b-2 border-cyan-500 pb-2">1. Nhập thông tin file</h2>
                    <form id="desktopLinkForm" class="space-y-4">
                        <div>
                            <label for="filePathInput" class="block mb-2 text-sm font-medium text-gray-300">Đường dẫn file tuyệt đối</label>
                            <input type="text" id="filePathInput" class="form-input block w-full rounded-lg border p-2.5" placeholder="Dán đường dẫn file vào đây, VD: C:\Users\Admin\Documents\file.docx" required>
                        </div>
                        <div>
                             <label for="displayNameInput" class="block mb-2 text-sm font-medium text-gray-300">Tên hiển thị (tùy chọn)</label>
                            <input type="text" id="displayNameInput" class="form-input block w-full rounded-lg border p-2.5" placeholder="Để trống sẽ lấy tên file gốc">
                        </div>
                        <button type="submit" class="w-full text-white bg-cyan-600 hover:bg-cyan-700 focus:ring-4 focus:outline-none focus:ring-cyan-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-colors duration-200">Tạo liên kết</button>
                    </form>
                </div>
                <!-- Right Column: Output -->
                 <div class="bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700 sticky top-8 self-start">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-semibold">2. Liên kết Markdown</h2>
                        <div>
                            <button id="desktopLinkCopyButton" class="bg-gray-700 hover:bg-gray-600 text-gray-300 font-medium py-1 px-3 rounded-lg text-sm transition-colors duration-200">Sao chép</button>
                            <div id="desktopLinkCopySuccess" class="bg-green-600 text-white font-medium py-1 px-3 rounded-lg text-sm hidden">Đã sao chép!</div>
                        </div>
                    </div>
                    <pre class="bg-gray-900 rounded-lg p-4 h-28 overflow-auto"><code id="desktopLinkOutput" class="text-sm text-gray-400 italic">Chưa có liên kết nào được tạo...</code></pre>
                    
                    <div class="mt-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-semibold">3. Link single</h2>
                            <div>
                                <button id="singleLinkCopyButton" class="bg-gray-700 hover:bg-gray-600 text-gray-300 font-medium py-1 px-3 rounded-lg text-sm transition-colors duration-200">Sao chép</button>
                                <div id="singleLinkCopySuccess" class="bg-green-600 text-white font-medium py-1 px-3 rounded-lg text-sm hidden">Đã sao chép!</div>
                            </div>
                        </div>
                        <pre class="bg-gray-900 rounded-lg p-4 h-28 overflow-auto"><code id="singleLinkOutput" class="text-sm text-gray-400 italic">Chưa có liên kết nào được tạo...</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center mt-12 pb-4">
        <p class="text-sm text-gray-500">© 2025 - Phần mềm thuộc về Xuân Hòa</p>
    </footer>

    <script>
        // --- TAB SWITCHING LOGIC ---
        const mainTabs = document.querySelectorAll('.main-tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        mainTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const target = tab.dataset.tab;
                
                mainTabs.forEach(t => {
                    t.classList.remove('active');
                    t.classList.add('text-gray-400', 'hover:text-gray-200', 'border-transparent');
                });
                tab.classList.add('active');
                tab.classList.remove('text-gray-400', 'hover:text-gray-200', 'border-transparent');
                
                tabContents.forEach(content => {
                    if (content.id === `${target}TabContent`) {
                        content.classList.add('active');
                    } else {
                        content.classList.remove('active');
                    }
                });
            });
        });


        // --- CHRONOS TIMELINE LOGIC ---
        // State management
        let tasks = [];
        let knownGroups = [];
        let activeTab = 'Tất cả';

        // DOM Elements
        const taskForm = document.getElementById('taskForm');
        const taskTypeSelect = document.getElementById('taskType');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const taskColorSelect = document.getElementById('taskColor');
        const taskGroupInput = document.getElementById('taskGroup');
        const taskNameInput = document.getElementById('taskName');
        const taskNoteInput = document.getElementById('taskNote');
        const taskListDiv = document.getElementById('taskList');
        const outputCodeEl = document.getElementById('outputCode');
        const copyButton = document.getElementById('copyButton');
        const copySuccessMessage = document.getElementById('copySuccessMessage');
        const groupSuggestionsDatalist = document.getElementById('group-suggestions');
        const dateError = document.getElementById('date-error');
        const submitButton = document.getElementById('submitButton');
        const editingTaskIdInput = document.getElementById('editingTaskId');
        const resetFormButton = document.getElementById('resetFormButton');
        
        // Containers for showing/hiding elements
        const endDateContainer = document.getElementById('endDateContainer');
        const detailsContainer = document.getElementById('detailsContainer');
        const groupContainer = document.getElementById('groupContainer');
        const taskNameContainer = document.getElementById('taskNameContainer');
        const noteContainer = document.getElementById('noteContainer');
        const tabContainer = document.getElementById('tab-container');

        // Initial generation
        generateCode();
        // Initial UI setup based on default selection
        taskTypeSelect.dispatchEvent(new Event('change'));

        // Event Listeners
        taskTypeSelect.addEventListener('change', (e) => {
            const type = e.target.value;
            const isMarker = type === 'marker';
            const isPeriod = type === 'period';
            const isEvent = type === 'event';

            endDateContainer.style.display = isMarker ? 'none' : 'block';
            detailsContainer.style.display = isMarker ? 'none' : 'grid';
            groupContainer.style.display = isMarker ? 'none' : 'block';
            
            taskNameContainer.style.display = isPeriod ? 'none' : 'block';
            noteContainer.style.display = isEvent ? 'block' : 'none';
            
            taskNameInput.required = !isPeriod;

            if (isMarker) {
                endDateInput.value = '';
                taskColorSelect.value = '';
                taskGroupInput.value = '';
            }
             if (!isEvent) {
                taskNoteInput.value = ''; // Clear note if not a "Task nhỏ"
            }
        });

        taskForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            // Date validation
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            if (endDate && startDate && new Date(endDate) < new Date(startDate)) {
                dateError.classList.remove('hidden');
                return;
            } else {
                dateError.classList.add('hidden');
            }

            const type = taskTypeSelect.value;
            const isPeriod = type === 'period';
            let name, description, newGroup;

            if (isPeriod) {
                newGroup = taskGroupInput.value.trim();
                name = newGroup;
                description = '';
            } else {
                name = taskNameInput.value.trim();
                description = taskNoteInput.value.trim();
                newGroup = taskGroupInput.value.trim();
            }

            if (newGroup && !knownGroups.includes(newGroup)) {
                knownGroups.push(newGroup);
                updateGroupSuggestions();
            }
            
            const editingId = parseInt(editingTaskIdInput.value, 10);
            if (editingId) {
                // Update existing task
                const taskIndex = tasks.findIndex(t => t.id === editingId);
                if (taskIndex > -1) {
                    tasks[taskIndex] = { ...tasks[taskIndex], type, startDate, endDate, color: taskColorSelect.value, group: newGroup, name, description };
                }
            } else {
                // Add new task
                const task = { id: Date.now(), type, startDate, endDate, color: taskColorSelect.value, group: newGroup, name, description };
                tasks.push(task);
            }
            
            resetForm();
            renderTaskList();
            generateCode();
        });

        taskListDiv.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;

            const taskId = parseInt(button.dataset.id, 10);
            
            if (button.classList.contains('delete-btn')) {
                tasks = tasks.filter(t => t.id !== taskId);
                renderTaskList();
                generateCode();
            } else if (button.classList.contains('edit-btn')) {
                const taskToEdit = tasks.find(t => t.id === taskId);
                if (taskToEdit) {
                    editingTaskIdInput.value = taskToEdit.id;
                    taskTypeSelect.value = taskToEdit.type;

                    if (taskToEdit.type === 'period') {
                        taskGroupInput.value = taskToEdit.name;
                        taskNameInput.value = '';
                        taskNoteInput.value = '';
                    } else {
                        taskGroupInput.value = taskToEdit.group;
                        taskNameInput.value = taskToEdit.name;
                        taskNoteInput.value = taskToEdit.description;
                    }
                    
                    startDateInput.value = taskToEdit.startDate;
                    endDateInput.value = taskToEdit.endDate;
                    taskColorSelect.value = taskToEdit.color;
                    
                    submitButton.textContent = 'Cập nhật công việc';
                    submitButton.classList.remove('bg-cyan-600', 'hover:bg-cyan-700');
                    submitButton.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                    
                    taskTypeSelect.dispatchEvent(new Event('change'));
                    taskGroupInput.focus();
                }
            }
        });

        [startDateInput, endDateInput].forEach(input => {
            input.addEventListener('change', () => {
                 const startDate = startDateInput.value;
                 const endDate = endDateInput.value;
                 if (endDate && startDate && new Date(endDate) < new Date(startDate)) {
                    dateError.classList.remove('hidden');
                } else {
                    dateError.classList.add('hidden');
                }
            });
        });
        
        resetFormButton.addEventListener('click', () => {
            editingTaskIdInput.value = '';
            taskTypeSelect.value = 'period';
            taskGroupInput.value = '';
            taskNameInput.value = '';
            taskNoteInput.value = '';
            startDateInput.value = '';
            endDateInput.value = '';
            taskColorSelect.value = '';
            
            submitButton.textContent = 'Thêm vào danh sách';
            submitButton.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
            submitButton.classList.add('bg-cyan-600', 'hover:bg-cyan-700');
            dateError.classList.add('hidden');
            
            taskTypeSelect.dispatchEvent(new Event('change'));
        });

        copyButton.addEventListener('click', () => {
            copyToClipboard(outputCodeEl.innerText, copyButton, copySuccessMessage);
        });

        // Core Functions
        function resetForm() {
            editingTaskIdInput.value = '';
            taskNameInput.value = '';
            taskNoteInput.value = '';
            startDateInput.value = '';
            endDateInput.value = '';
            taskColorSelect.value = '';
            // taskTypeSelect's value is intentionally kept
            submitButton.textContent = 'Thêm vào danh sách';
            submitButton.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
            submitButton.classList.add('bg-cyan-600', 'hover:bg-cyan-700');
            dateError.classList.add('hidden');
            taskTypeSelect.dispatchEvent(new Event('change'));
        }

        function updateGroupSuggestions() {
            groupSuggestionsDatalist.innerHTML = knownGroups.map(group => `<option value="${group}"></option>`).join('');
        }

        function renderTaskList() {
            if (tasks.length === 0) {
                tabContainer.innerHTML = '';
                taskListDiv.innerHTML = `<p class="text-gray-400 text-center italic">Chưa có công việc nào được thêm...</p>`;
                return;
            }

            const groupedTasks = tasks.reduce((acc, task) => {
                const groupKey = task.type === 'marker' ? 'Task quan trọng' : (task.group || 'Chưa phân loại');
                if (!acc[groupKey]) acc[groupKey] = [];
                acc[groupKey].push(task);
                return acc;
            }, {});
            
            const groupNames = Object.keys(groupedTasks);
            if (!groupNames.includes(activeTab) && activeTab !== 'Tất cả') {
                activeTab = 'Tất cả';
            }

            // Render Tabs
            const allGroupNames = ['Tất cả', ...groupNames];
            tabContainer.innerHTML = allGroupNames.map(name => {
                const isActive = name === activeTab;
                const activeClasses = 'border-cyan-400 text-cyan-400';
                const inactiveClasses = 'border-transparent text-gray-400 hover:text-gray-200 hover:border-gray-500';
                return `<button data-group="${name}" class="tab-btn py-2 px-4 font-medium border-b-2 ${isActive ? activeClasses : inactiveClasses} transition-colors duration-200 whitespace-nowrap">${name}</button>`;
            }).join('');

            // Render Content
            let html = '';
            for (const groupName in groupedTasks) {
                const isVisible = activeTab === 'Tất cả' || activeTab === groupName;
                html += `<div class="task-group-content ${isVisible ? '' : 'hidden'}" data-group-content="${groupName}">`;
                html += groupedTasks[groupName].map(task => {
                    const typeSymbol = { period: '@', event: '-', marker: '=' }[task.type];
                    const isSingleTaskGroup = groupedTasks[groupName].length === tasks.length;
                    const showGroupPill = task.type !== 'period' && task.group && !isSingleTaskGroup;

                    return `
                        <div class="bg-gray-700 p-3 rounded-lg flex justify-between items-center text-sm mb-2">
                            <div class="flex-grow mr-2 overflow-hidden">
                                <span class="font-bold text-cyan-400 mr-2">${typeSymbol}</span>
                                <span class="font-medium truncate">${task.name}</span>
                                ${showGroupPill ? `<span class="text-xs bg-gray-600 text-gray-300 rounded-full px-2 py-0.5 ml-2 whitespace-nowrap">${task.group}</span>` : ''}
                            </div>
                            <div class="flex-shrink-0">
                                <button data-id="${task.id}" class="edit-btn text-yellow-400 hover:text-yellow-300 font-bold px-2">Sửa</button>
                                <button data-id="${task.id}" class="delete-btn text-red-400 hover:text-red-300 font-bold px-2">Xóa</button>
                            </div>
                        </div>`;
                }).join('');
                html += `</div>`;
            }
            taskListDiv.innerHTML = html;
        }
        
        tabContainer.addEventListener('click', e => {
            const tabButton = e.target.closest('.tab-btn');
            if (!tabButton) return;
            activeTab = tabButton.dataset.group;
            renderTaskList(); // Re-render to update active tab styles and content visibility
        });

        function formatDate(dateString) {
            if (!dateString) return '';
            return dateString;
        }

        function generateCode() {
            let code = '```chronos\n';
            code += '# --- DANH SÁCH CÔNG VIỆC CHI TIẾT ---\n\n';

            const groupedTasks = tasks.reduce((acc, task) => {
                const groupKey = task.type === 'marker' ? 'Task quan trọng' : (task.group || 'Chưa phân loại');
                if (!acc[groupKey]) acc[groupKey] = [];
                acc[groupKey].push(task);
                return acc;
            }, {});

            for (const groupName in groupedTasks) {
                if (groupName === 'Task quan trọng') {
                     code += `# TASK QUAN TRỌNG\n`;
                } else if (groupName !== 'Chưa phân loại') {
                     code += `# NHÓM ${groupName.toUpperCase()}\n`;
                }
               
                groupedTasks[groupName].forEach(task => {
                    const typeSymbol = { period: '@', event: '-', marker: '=' }[task.type];
                    let datePart = `[${formatDate(task.startDate)}`;
                    if (task.endDate) datePart += `~${formatDate(task.endDate)}`;
                    datePart += ']';
                    let colorPart = task.color ? ` ${task.color}` : '';
                    let groupPart = task.group ? ` {${task.group}}` : '';
                    let namePart = ` ${task.name}`;
                    let descriptionPart = task.description ? ` | ${task.description}` : '';
                    
                    if (task.type === 'marker') {
                        code += `${typeSymbol} ${datePart}${namePart}${descriptionPart}\n`;
                    } else {
                        code += `${typeSymbol} ${datePart}${colorPart}${groupPart}${namePart}${descriptionPart}\n`;
                    }
                });
                 code += '\n'; 
            }

            code += '```';
            outputCodeEl.textContent = code;
        }

        // --- DESKTOP LINK LOGIC ---
        const desktopLinkForm = document.getElementById('desktopLinkForm');
        const filePathInput = document.getElementById('filePathInput');
        const displayNameInput = document.getElementById('displayNameInput');
        const desktopLinkOutput = document.getElementById('desktopLinkOutput');
        const desktopLinkCopyButton = document.getElementById('desktopLinkCopyButton');
        const desktopLinkCopySuccess = document.getElementById('desktopLinkCopySuccess');
        const singleLinkOutput = document.getElementById('singleLinkOutput');
        const singleLinkCopyButton = document.getElementById('singleLinkCopyButton');
        const singleLinkCopySuccess = document.getElementById('singleLinkCopySuccess');

        desktopLinkForm.addEventListener('submit', (e) => {
            e.preventDefault();
            let rawPath = filePathInput.value.trim();
            if (!rawPath) return;

            // Trim quotes if present
            if (rawPath.startsWith('"') && rawPath.endsWith('"')) {
                rawPath = rawPath.substring(1, rawPath.length - 1);
            }

            // 1. Normalize slashes
            let processedPath = rawPath.replace(/\\/g, '/');

            // 2. More robust encoding: separate drive letter from path
            let drivePart = '';
            let pathPart = processedPath;

            // Check for drive letter pattern e.g., "C:/"
            const driveMatch = processedPath.match(/^([a-zA-Z]:\/)/);
            if (driveMatch) {
                drivePart = driveMatch[1]; // "C:/"
                pathPart = processedPath.substring(drivePart.length); // The rest of the path
            }
            
            // 3. Encode each component of the remaining path
            const encodedPathPart = pathPart.split('/').map(part => encodeURIComponent(part)).join('/');
            
            const finalEncodedPath = drivePart + encodedPathPart;

            // 4. Get display name
            let displayName = displayNameInput.value.trim();
            if (!displayName) {
                const fileNameWithExt = rawPath.split(/\\|\//).pop(); // Get filename
                const lastDotIndex = fileNameWithExt.lastIndexOf('.');
                displayName = lastDotIndex > -1 ? fileNameWithExt.slice(0, lastDotIndex) : fileNameWithExt;
            }
            
            // 5. Create final links
            const markdownLink = `[${displayName}](file:///${finalEncodedPath})`;
            const singleLink = `file:///${finalEncodedPath}`;
            
            // 6. Display results
            desktopLinkOutput.textContent = markdownLink;
            desktopLinkOutput.classList.remove('text-gray-400', 'italic');

            singleLinkOutput.textContent = singleLink;
            singleLinkOutput.classList.remove('text-gray-400', 'italic');
        });

        desktopLinkCopyButton.addEventListener('click', () => {
            if (desktopLinkOutput.textContent && !desktopLinkOutput.classList.contains('italic')) {
                copyToClipboard(desktopLinkOutput.innerText, desktopLinkCopyButton, desktopLinkCopySuccess);
            }
        });

        singleLinkCopyButton.addEventListener('click', () => {
            if (singleLinkOutput.textContent && !singleLinkOutput.classList.contains('italic')) {
                copyToClipboard(singleLinkOutput.innerText, singleLinkCopyButton, singleLinkCopySuccess);
            }
        });


        // --- UTILITY FUNCTIONS ---
        function copyToClipboard(text, button, successMessage) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                button.classList.add('hidden');
                successMessage.classList.remove('hidden');
                setTimeout(() => {
                    successMessage.classList.add('hidden');
                    button.classList.remove('hidden');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
            document.body.removeChild(textarea);
        }
    </script>
</body>
</html>

